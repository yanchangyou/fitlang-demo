<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/fitlang.svg"/>
</head>
<body>
<center>
    <div style="text-align:right;margin-right:50px;">
        &nbsp;<a target="" href="/">root</a>
        &nbsp;<a target="" href="/online.html">online</a>
        &nbsp;<a target="" href="/demo/monitor/index.html">monitor</a>
        &nbsp;<a target="_blank" href="/_api">api</a>
        &nbsp;<a target="_blank" href="https://plugins.jetbrains.com/plugin/22593-fitlang/fitlang">doc</a>
        &nbsp;<a target="_blank" href="https://plugins.jetbrains.com/plugin/22593-fitlang/plugin">plugin</a>
        &nbsp;<a target="_blank" href="https://github.com/yanchangyou/fitlang">github</a>
        &nbsp;<a target="_blank" href="https://github.com/yanchangyou/fitlang-demo">demo</a>
    </div>
    <h2>FitServer 0.5.13</h2>

    <form onsubmit="return false;">
        <h4>输入代码</h4>
        <textarea type="text" id="input" name="message" style="width:700px; height: 200px;">{"uni":"hello","message":"hello world!"}</textarea>
        <br/><br/>
        <div style="text-align:left;margin-left:60%;">
            <input type="button" value="执行" onclick="execute();">&nbsp;&nbsp;
            <input type="button" value="格式化" onclick="format()">&nbsp;&nbsp;
            <input type="button" value="打卡" style="color:green;" onclick="clockIn();">&nbsp;&nbsp;
        </div>
        <h4>输出结果</h4>
        <textarea id="output" style="width:700px; height: 200px;">{}</textarea>
    </form>

</center>
<script type="text/javascript">
    var socket;
    function connectionWs() {
        if (!window.WebSocket) {
            window.WebSocket = window.MozWebSocket;
        }
        if (window.WebSocket) {
            socket = new WebSocket("ws://" + window.location.hostname + ":20000/");
            socket.onmessage = function (event) {
                console.log(event)
                var ta = document.getElementById('output');
                ta.value = event.data;
            };
            socket.onopen = function (event) {
                var ta = document.getElementById('output');
                ta.value ='{"message":"支持打卡"}';
            };
            socket.onclose = function (event) {
                var ta = document.getElementById('output');
                ta.value ='{"message":"WebSocket 关闭!"}';
            }
        } else {
            alert("抱歉，您的浏览器不支持WebSocket协议!");
        }
    }

    connectionWs();

    function send(message) {
        if (!window.WebSocket) {
            return;
        }
        if (socket.readyState == WebSocket.OPEN) {
            socket.send(message);
        }else {
            alert("WebSocket连接没有建立成功!");
        }
    }

    var httpRequest = new XMLHttpRequest();

    function request(action, url, input, callback) {
        httpRequest.open(action, url, true);
        httpRequest.onreadystatechange = function(message) {
            if (httpRequest.readyState == 4 && httpRequest.status == 200) {
                callback(httpRequest.responseText);
            }
        };
        var body = null;
        if(typeof(input)==="string") {
            body = input;
        } else if(typeof(input)==="object") {
            body = JSON.stringify(input);
        }
        httpRequest.send(body);
    }

    function format() {
       formatText('input');
       formatText('output');
    }

    function formatText(domId) {
        var inputText = document.getElementById(domId).value;
        document.getElementById(domId).value = JSON.stringify(JSON.parse(inputText), 2,'  ');
    }

    function clockIn() {
        var vendor = navigator.vendor;
        var appVersion = navigator.appVersion;
        var appCodeName = navigator.appCodeName;
        var data = {
            "clientInfo":{
                "clientType":"browser",
                "vendor":vendor,
//                "appVersion":appVersion,
                "appCodeName":appCodeName,
            }
        };
        send(JSON.stringify(data));
        var isGoto = confirm("查看在线打开信息");
        if(isGoto) {
            window.open("/_cloud?_jsonFormat=true");
        }
    }

    function execute() {
        var inputText = document.getElementById('input').value;
        var url = "/execute"
        request("POST", url, inputText, function(body){
            document.getElementById('output').value = body;
        });
    }
</script>

</body>
</html>